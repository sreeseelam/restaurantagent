<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Restaurant Agent Chat</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 flex flex-col h-screen">
  <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-2"></div>

  <div id="input-container" class="flex items-center p-4 bg-white border-t border-gray-300">
    <textarea id="user-input" rows="1" placeholder="Type your message..." class="flex-1 p-2 border rounded resize-none focus:outline-none focus:ring" onkeydown="handleEnter(event)"></textarea>
    <button onclick="sendMessage()" class="ml-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Send</button>
    <button onclick="resetChat()" class="ml-2 px-4 py-2 bg-gray-300 text-gray-800 rounded hover:bg-gray-400">Reset</button>
  </div>

  <script>
    let sessionId = "session_" + Math.random().toString(36).substring(2);

    async function startSession() {
      const res = await fetch('/start-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
      const data = await res.json();
      console.log('Session started:', data);
    }

    async function sendMessage() {
      const input = document.getElementById('user-input');
      const message = input.value.trim();
      if (!message) return;

      appendMessage('user', message);
      input.value = '';

      // Typing indicator
      appendMessage('assistant', 'Typing...', true);

      const res = await fetch('/send-message', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId, message })
      });

      const data = await res.json();
      removeTyping();
      appendMessage('assistant', data.response);
    }

    async function resetChat() {
      await fetch('/clear-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: sessionId })
      });
      sessionId = "session_" + Math.random().toString(36).substring(2);
      await startSession();
      document.getElementById('chat-container').innerHTML = '';
    }

    function appendMessage(role, content, isTyping = false) {
      const div = document.createElement('div');
      div.className = `message ${role}`;
      div.classList.add("text-sm", "rounded", "p-2", "max-w-xl", "whitespace-pre-wrap");

      const roleClasses = role === 'user'
        ? ["bg-blue-100", "self-end"]
        : ["bg-green-100", "self-start"];
      div.classList.add(...roleClasses);

      div.textContent = `${role === 'user' ? 'You' : 'Assistant'}: ${content}`;
      if (isTyping) div.id = "typing-indicator";

      const time = document.createElement('div');
      time.className = "text-xs text-gray-500 mt-1";
      time.textContent = new Date().toLocaleTimeString();
      div.appendChild(time);

      document.getElementById('chat-container').appendChild(div);
      div.scrollIntoView({ behavior: 'smooth' });
    }

    function removeTyping() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    function handleEnter(event) {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendMessage();
      }
    }

    // Initialize
    startSession();
  </script>
</body>
</html>